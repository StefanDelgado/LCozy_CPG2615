---
deployment:
  tasks:
    # ===================================
    # OPTIMIZED DEPLOYMENT - Only sync changed files
    # ===================================
    - export DEPLOYPATH=/home/yyju4g9j6ey3/public_html/
    
    # ===================================
    # STEP 1: Quick cleanup (old files only)
    # ===================================
    - /bin/rm -f $DEPLOYPATH/login.php
    - /bin/rm -f $DEPLOYPATH/register.php
    - /bin/rm -f $DEPLOYPATH/register_admin.php
    - /bin/rm -f $DEPLOYPATH/logout.php
    - /bin/rm -f $DEPLOYPATH/auth.php
    - /bin/rm -f $DEPLOYPATH/dashboard.php
    - /bin/rm -f $DEPLOYPATH/student_dashboard.php
    - /bin/rm -f $DEPLOYPATH/owner_dashboard.php
    - /bin/rm -f $DEPLOYPATH/download_log.php
    - /bin/rm -f $DEPLOYPATH/test-pdo.php

    # ===================================
    # STEP 2: Use rsync for FAST incremental sync
    # ===================================
    
    # Core files (always update these)
    - /bin/cp -f config.php $DEPLOYPATH
    - /bin/cp -f index.php $DEPLOYPATH
    
    # Sync directories (only changed files) - MUCH FASTER!
    - /usr/bin/rsync -a --delete auth/ $DEPLOYPATH/auth/
    - /usr/bin/rsync -a --delete dashboards/ $DEPLOYPATH/dashboards/
    - /usr/bin/rsync -a --delete admin/ $DEPLOYPATH/admin/
    - /usr/bin/rsync -a --delete modules/ $DEPLOYPATH/modules/
    - /usr/bin/rsync -a --delete partials/ $DEPLOYPATH/partials/
    - /usr/bin/rsync -a --delete public/ $DEPLOYPATH/public/
    
    # Assets - sync without delete (preserve uploaded files)
    - /usr/bin/rsync -a --exclude='uploads/*' assets/ $DEPLOYPATH/assets/
    
    # Uploads - only add new, never delete
    - /bin/mkdir -p $DEPLOYPATH/uploads/receipts
    - /bin/mkdir -p $DEPLOYPATH/uploads/rooms
    - /usr/bin/rsync -a --ignore-existing uploads/ $DEPLOYPATH/uploads/
    
    # Cron scripts
    - /usr/bin/rsync -a cron/ $DEPLOYPATH/cron/
    
    # Set permissions only on changed directories
    - /bin/find $DEPLOYPATH/auth -type f -exec chmod 644 {} \;
    - /bin/find $DEPLOYPATH/auth -type d -exec chmod 755 {} \;
    - /bin/find $DEPLOYPATH/dashboards -type f -exec chmod 644 {} \;
    - /bin/find $DEPLOYPATH/dashboards -type d -exec chmod 755 {} \;
    - /bin/find $DEPLOYPATH/modules -type f -exec chmod 644 {} \;
    - /bin/find $DEPLOYPATH/modules -type d -exec chmod 755 {} \;
    - /bin/chmod -R 775 $DEPLOYPATH/uploads
